"use strict";var ZoteroPluginUTS=(()=>{var d=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var k=(e,t)=>{for(var o in t)d(e,o,{get:t[o],enumerable:!0})},D=(e,t,o,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of L(t))!N.call(e,n)&&n!==o&&d(e,n,{get:()=>t[n],enumerable:!(r=F(t,n))||r.enumerable});return e};var B=e=>D(d({},"__esModule",{value:!0}),e);var ue={};k(ue,{addToWindow:()=>p,onWindowLoad:()=>ne,onWindowUnload:()=>ie,removeFromWindow:()=>g,shutdown:()=>ae,startup:()=>ce});var s="uts-copy@gracefullight.dev",c="uts-copy-menuitem",a="uts-copy-tools-menuitem",u="uts-copy-key",l="Copy UTS APA 7th Citation";var U="http://www.zotero.org/styles/uts-apa-7th";function b(e){return`Copied ${e} citation${e>1?"s":""} to clipboard`}function x(e){return`bibliography=${e}`}function S(e){return typeof e=="string"?e:e.text||""}function m(e,t=!1){try{let o=new Zotero.ProgressWindow;o.changeHeadline(t?"UTS Copy Error":"UTS Copy"),o.addDescription(e),o.show(),o.startCloseTimer(3e3)}catch(o){Zotero.debug(`UTS Copy: Notification error: ${o}`)}}async function $(e){globalThis.navigator?.clipboard?await globalThis.navigator.clipboard.writeText(e):Components.classes["@mozilla.org/widget/clipboardhelper;1"].getService(Components.interfaces.nsIClipboardHelper).copyString(e)}async function W(){let e=Zotero.getActiveZoteroPane();if(!e)return{success:!1,error:"No active pane"};let t=e.getSelectedItems();if(!t||t.length===0)return{success:!1,error:"No items selected"};let o=x(U),r=Zotero.QuickCopy.getContentFromItems(t,o),n=S(r);return n?(await $(n),{success:!0,count:t.length}):{success:!1,error:"Failed to generate citation"}}async function f(){try{let e=await W();e.success?(m(b(e.count)),Zotero.debug(`UTS Copy: Copied ${e.count} citation(s) to clipboard`)):(m(e.error,!0),Zotero.debug(`UTS Copy Error: ${e.error}`))}catch(e){let t=e instanceof Error?e.message:String(e);m(`Error: ${t}`,!0),Zotero.debug(`UTS Copy Error: ${t}`)}}var y=class{context=null;initialize(t){this.context=t}get rootURI(){return this.context?.rootURI??""}get pluginID(){return this.context?.id??""}get version(){return this.context?.version??""}isInitialized(){return this.context!==null}reset(){this.context=null}},i=new y;var Z={itemContext:"main/library/item",toolsMenu:"main/menubar/tools"};function v(e){Zotero.Menu?H(e):z(e)}function h(){Zotero.Menu?O():G()}function H(e){let t=i.rootURI?`${i.rootURI}icon.svg`:void 0;Zotero.Menu?.registerMenu(s,Z.itemContext,{id:c,label:l,icon:t,commandListener:e}),Zotero.Menu?.registerMenu(s,Z.toolsMenu,{id:a,label:l,icon:t,commandListener:e}),Zotero.debug("UTS Copy: Registered menus via Zotero 8 API")}function O(){Zotero.Menu?.unregisterMenu(s,c),Zotero.Menu?.unregisterMenu(s,a),Zotero.debug("UTS Copy: Unregistered menus via Zotero 8 API")}function z(e){for(let t of Zotero.getMainWindows())E(t,e);Zotero.debug("UTS Copy: Registered menus via legacy API")}function G(){for(let e of Zotero.getMainWindows())w(e);Zotero.debug("UTS Copy: Unregistered menus via legacy API")}function E(e,t){let o=e.document;V(o,t),X(o,t),K(o,t)}function w(e){let t=e.document;t.getElementById(c)?.remove(),t.getElementById(a)?.remove(),t.getElementById(u)?.remove()}function V(e,t){let o=e.getElementById("zotero-itemmenu");if(!o)return;e.getElementById(c)?.remove();let r=T(e);r.id=c,r.addEventListener("command",t),o.appendChild(r)}function X(e,t){let o=e.getElementById("menu_ToolsPopup");if(!o)return;e.getElementById(a)?.remove();let r=T(e);r.id=a,r.setAttribute("key",u),r.addEventListener("command",t),o.appendChild(r)}function K(e,t){let o=e.getElementById("mainKeyset")??e.querySelector("keyset")??e.documentElement;e.getElementById(u)?.remove();let r=e.createXULElement?e.createXULElement("key"):e.createElement("key");r.id=u,r.setAttribute("modifiers","accel,shift"),r.setAttribute("key","U"),r.setAttribute("oncommand","void(0);"),r.addEventListener("command",t),o.appendChild(r)}function T(e){let t=e.createXULElement?e.createXULElement("menuitem"):e.createElement("menuitem");t.setAttribute("label",l),t.setAttribute("class","menuitem-iconic");let o=i.rootURI;return o&&t.setAttribute("image",`${o}icon.svg`),t}function p(e,t){Zotero.Menu||E(e,t)}function g(e){Zotero.Menu||w(e)}var M="extensions.zotero.uts-copy",R=`${M}.firstRun`,A=`${M}.version`;function Y(e,t){try{return Services.prefs.getBoolPref(e,t)}catch{return t}}function q(e,t){try{Services.prefs.setBoolPref(e,t)}catch(o){Zotero.debug(`UTS Copy: Failed to set pref ${e}: ${o}`)}}function Q(e,t){try{return Services.prefs.getCharPref(e,t)}catch{return t}}function j(e,t){try{Services.prefs.setCharPref(e,t)}catch(o){Zotero.debug(`UTS Copy: Failed to set char pref ${e}: ${o}`)}}function J(){return Y(R,!0)}function ee(){q(R,!1)}function te(){return Q(A,"")}function oe(e){j(A,e)}function re(){try{let e=new Zotero.ProgressWindow;e.changeHeadline("UTS APA 7th Copy Installed!"),e.addDescription(`Thank you for installing UTS Copy!

Use Ctrl+Shift+U (Cmd+Shift+U on Mac) to copy citations.

If you find this plugin helpful, please consider supporting development.`),e.show(),e.startCloseTimer(8e3)}catch(e){Zotero.debug(`UTS Copy: Welcome notification error: ${e}`)}}function C(e){let t=J(),o=te();(t||o!==e)&&(re(),ee(),oe(e))}function I(){try{let e=Zotero;e.PreferencePanes&&(e.PreferencePanes.register({pluginID:s,src:"chrome://uts-copy/content/preferences.xhtml",label:"UTS Copy",image:"chrome://uts-copy/content/icon.svg"}),Zotero.debug("UTS Copy: Preference pane registered"))}catch(e){Zotero.debug(`UTS Copy: Failed to register preference pane: ${e}`)}}async function P(e){try{let t=`${e}uts-apa.csl`,o=await fetch(t);if(!o.ok){Zotero.debug(`UTS Copy: Failed to fetch style ${t}`);return}let r=await o.text();await Zotero.Styles.install(r,t,!1),Zotero.debug("UTS Copy: Installed UTS APA 7th style")}catch(t){Zotero.debug(`UTS Copy: Error installing style: ${t}`)}}var _=async()=>f();function ne(e){p(e,_)}function ie(e){g(e)}function se(e){try{Cc["@mozilla.org/network/protocol;1?name=resource"].getService(Ci.nsIResProtocolHandler).registerResource("uts-copy",Services.io.newURI(e)),Cc["@mozilla.org/network/protocol;1?name=chrome"].getService(Ci.nsIResProtocolHandler).registerResource("uts-copy",Services.io.newURI(`${e}content/`)),Zotero.debug("UTS Copy: Chrome resources registered")}catch(t){Zotero.debug(`UTS Copy: Chrome registration skipped: ${t}`)}}async function ce(e){Zotero.debug("UTS Copy: Startup"),i.initialize(e),se(e.rootURI),await P(e.rootURI),v(_),I(),C(e.version)}function ae(){Zotero.debug("UTS Copy: Shutdown"),h(),i.reset()}return B(ue);})();
