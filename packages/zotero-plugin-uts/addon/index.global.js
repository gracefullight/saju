"use strict";var ZoteroPluginUTS=(()=>{var m=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var G=Object.prototype.hasOwnProperty;var H=(e,t)=>{for(var o in t)m(e,o,{get:t[o],enumerable:!0})},z=(e,t,o,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of W(t))!G.call(e,n)&&n!==o&&m(e,n,{get:()=>t[n],enumerable:!(r=k(t,n))||r.enumerable});return e};var K=e=>z(m({},"__esModule",{value:!0}),e);var Ie={};H(Ie,{addToWindow:()=>f,onPrefsEvent:()=>I,onWindowLoad:()=>ve,onWindowUnload:()=>Ce,removeFromWindow:()=>p,shutdown:()=>Ee,startup:()=>be});var h="https://github.com/sponsors/gracefullight",y="https://buymeacoffee.com/gracefullight",T="https://github.com/gracefullight/pkgs";var g={STAR:5,COFFEE:15,SPONSOR:30},a={COPY_COUNT:"extensions.zotero-uts.copyCount",NUDGE_STAR_SHOWN:"extensions.zotero-uts.nudgeStarShown",NUDGE_COFFEE_SHOWN:"extensions.zotero-uts.nudgeCoffeeShown",NUDGE_SPONSOR_SHOWN:"extensions.zotero-uts.nudgeSponsorShown"};var s="uts-citation@gracefullight.dev",c="uts-citation-menuitem",u="uts-citation-tools-menuitem",l="uts-citation-key",d="Copy UTS APA 7th Citation";var N="http://www.zotero.org/styles/uts-apa-7th";var X=[{threshold:g.STAR,prefKey:a.NUDGE_STAR_SHOWN,title:"UTS Citation \u2B50",message:"Like it? Star us on GitHub!",url:T},{threshold:g.COFFEE,prefKey:a.NUDGE_COFFEE_SHOWN,title:"UTS Citation \u2615",message:"Buy me a coffee?",url:y},{threshold:g.SPONSOR,prefKey:a.NUDGE_SPONSOR_SHOWN,title:"UTS Citation \u{1F49C}",message:"Become a sponsor!",url:h}];function Y(e,t){try{return Services.prefs.getIntPref(e,t)}catch{return t}}function V(e,t){try{Services.prefs.setIntPref(e,t)}catch(o){Zotero.debug(`UTS Citation: Failed to set int pref ${e}: ${o}`)}}function q(e,t){try{return Services.prefs.getBoolPref(e,t)}catch{return t}}function Q(e,t){try{Services.prefs.setBoolPref(e,t)}catch(o){Zotero.debug(`UTS Citation: Failed to set bool pref ${e}: ${o}`)}}function j(){return Y(a.COPY_COUNT,0)}function J(){let e=j()+1;return V(a.COPY_COUNT,e),e}function ee(e){return q(e,!1)}function te(e){Q(e,!0)}function oe(e){try{let t=new Zotero.ProgressWindow;t.changeHeadline(e.title),t.addDescription(`${e.message}

\u{1F449} ${e.url}`),t.show(),t.startCloseTimer(6e3),te(e.prefKey),Zotero.debug(`UTS Citation: Showed nudge for ${e.prefKey}`)}catch(t){Zotero.debug(`UTS Citation: Nudge notification error: ${t}`)}}function Z(){let e=J();for(let t of X)if(e===t.threshold&&!ee(t.prefKey)){oe(t);break}}function w(e){return`Copied ${e} citation${e>1?"s":""} to clipboard`}function _(e){return`bibliography=${e}`}function R(e){return typeof e=="string"?e:e.text||""}function U(e,t=!1){try{let o=new Zotero.ProgressWindow;o.changeHeadline(t?"UTS Citation Error":"UTS Citation"),o.addDescription(e),o.show(),o.startCloseTimer(3e3)}catch(o){Zotero.debug(`UTS Citation: Notification error: ${o}`)}}async function re(e){globalThis.navigator?.clipboard?await globalThis.navigator.clipboard.writeText(e):Components.classes["@mozilla.org/widget/clipboardhelper;1"].getService(Components.interfaces.nsIClipboardHelper).copyString(e)}async function ne(){let e=Zotero.getActiveZoteroPane();if(!e)return{success:!1,error:"No active pane"};let t=e.getSelectedItems();if(!t||t.length===0)return{success:!1,error:"No items selected"};let o=_(N),r=Zotero.QuickCopy.getContentFromItems(t,o),n=R(r);return n?(await re(n),{success:!0,count:t.length}):{success:!1,error:"Failed to generate citation"}}async function P(){try{let e=await ne();e.success?(U(w(e.count)),Zotero.debug(`UTS Citation: Copied ${e.count} citation(s) to clipboard`),Z()):(U(e.error,!0),Zotero.debug(`UTS Citation Error: ${e.error}`))}catch(e){let t=e instanceof Error?e.message:String(e);U(`Error: ${t}`,!0),Zotero.debug(`UTS Citation Error: ${t}`)}}var S=class{context=null;initialize(t){this.context=t}get rootURI(){return this.context?.rootURI??""}get pluginID(){return this.context?.id??""}get version(){return this.context?.version??""}isInitialized(){return this.context!==null}reset(){this.context=null}},i=new S;var F={itemContext:"main/library/item",toolsMenu:"main/menubar/tools"};function v(e){Zotero.Menu?ie(e):ae(e)}function C(){Zotero.Menu?se():ce()}function ie(e){let t=i.rootURI?`${i.rootURI}icon.svg`:void 0;Zotero.Menu?.registerMenu(s,F.itemContext,{id:c,label:d,icon:t,commandListener:e}),Zotero.Menu?.registerMenu(s,F.toolsMenu,{id:u,label:d,icon:t,commandListener:e}),Zotero.debug("UTS Citation: Registered menus via Zotero 8 API")}function se(){Zotero.Menu?.unregisterMenu(s,c),Zotero.Menu?.unregisterMenu(s,u),Zotero.debug("UTS Citation: Unregistered menus via Zotero 8 API")}function ae(e){for(let t of Zotero.getMainWindows())M(t,e);Zotero.debug("UTS Citation: Registered menus via legacy API")}function ce(){for(let e of Zotero.getMainWindows())A(e);Zotero.debug("UTS Citation: Unregistered menus via legacy API")}function M(e,t){let o=e.document;ge(o,t),ue(o,t),le(o,t)}function A(e){let t=e.document;t.getElementById(c)?.remove(),t.getElementById(u)?.remove();let o=t.getElementById(l);o&&o.remove()}function ue(e,t){let o=e.getElementById("zotero-itemmenu");if(!o)return;e.getElementById(c)?.remove();let r=L(e);r.id=c,r.addEventListener("command",t),o.appendChild(r)}function le(e,t){let o=e.getElementById("menu_ToolsPopup");if(!o)return;e.getElementById(u)?.remove();let r=L(e);r.id=u,r.setAttribute("key",l),r.addEventListener("command",t),o.appendChild(r)}function ge(e,t){let o=e.getElementById("mainKeyset")??e.querySelector("keyset")??e.documentElement;e.getElementById(l)?.remove();let r=e.createXULElement?e.createXULElement("key"):e.createElement("key");r.id=l,r.setAttribute("modifiers","accel,shift"),r.setAttribute("key","U"),r.setAttribute("oncommand","void(0);"),r.addEventListener("command",t),o.appendChild(r)}function L(e){let t=e.createXULElement?e.createXULElement("menuitem"):e.createElement("menuitem");t.setAttribute("label",d),t.setAttribute("class","menuitem-iconic");let o=i.rootURI;return o&&t.setAttribute("image",`${o}icon.svg`),t}function f(e,t){Zotero.Menu||M(e,t)}function p(e){Zotero.Menu||A(e)}var O="extensions.zotero.uts-citation",D=`${O}.firstRun`,B=`${O}.version`;function de(e,t){try{return Services.prefs.getBoolPref(e,t)}catch{return t}}function fe(e,t){try{Services.prefs.setBoolPref(e,t)}catch(o){Zotero.debug(`UTS Citation: Failed to set pref ${e}: ${o}`)}}function pe(e,t){try{return Services.prefs.getCharPref(e,t)}catch{return t}}function me(e,t){try{Services.prefs.setCharPref(e,t)}catch(o){Zotero.debug(`UTS Citation: Failed to set char pref ${e}: ${o}`)}}function he(){return de(D,!0)}function ye(){fe(D,!1)}function Ue(){return pe(B,"")}function Pe(e){me(B,e)}function Se(){try{let e=new Zotero.ProgressWindow;e.changeHeadline("UTS APA 7th Citation Installed!"),e.addDescription(`Thank you for installing UTS Citation!

Use Ctrl+Shift+U (Cmd+Shift+U on Mac) to copy citations.

If you find this plugin helpful, please consider supporting development.`),e.show(),e.startCloseTimer(8e3)}catch(e){Zotero.debug(`UTS Citation: Welcome notification error: ${e}`)}}function b(e){let t=he(),o=Ue();(t||o!==e)&&(Se(),ye(),Pe(e))}function E(e){try{let t=Zotero;t.PreferencePanes&&(t.PreferencePanes.register({pluginID:s,src:`${e}content/preferences.xhtml`,label:"UTS Citation",image:`${e}content/icon.svg`,defaultXUL:!0}),Zotero.debug("UTS Citation: Preference pane registered"))}catch(t){Zotero.debug(`UTS Citation: Failed to register preference pane: ${t}`)}}function I(e,t){e==="load"&&Zotero.debug("UTS Citation: Preferences loaded")}async function x(e){try{let t=`${e}uts-apa.csl`,o=await fetch(t);if(!o.ok){Zotero.debug(`UTS Citation: Failed to fetch style ${t}`);return}let r=await o.text();await Zotero.Styles.install(r,t,!0),Zotero.debug("UTS Citation: Installed UTS APA 7th style")}catch(t){Zotero.debug(`UTS Citation: Error installing style: ${t}`)}}var $=async()=>P();function ve(e){f(e,$)}function Ce(e){p(e)}async function be(e){Zotero.debug("UTS Citation: Startup"),i.initialize(e),await x(e.rootURI),v($),E(e.rootURI),b(e.version)}function Ee(){Zotero.debug("UTS Citation: Shutdown"),C(),i.reset()}return K(Ie);})();
